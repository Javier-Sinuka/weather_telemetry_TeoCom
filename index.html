<script>
  const DATA_URL = './data/data.json';

  const createChart = (ctx, label) => new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{ label, data: [], tension: 0.25 }] },
    options: {
      responsive: true,
      scales: {
        x: { title: { display: true, text: 'Tiempo' } },
        y: { beginAtZero: false }
      },
      plugins: { legend: { display: true } }
    }
  });

  const tempChart = createChart(document.getElementById('tempChart'), 'Â°C');
  const humChart  = createChart(document.getElementById('humChart'),  '%');
  const presChart = createChart(document.getElementById('presChart'), 'hPa');

  async function loadData() {
    try {
      // cache-busting para GitHub Pages
      const url = `${DATA_URL}?t=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('No se pudo leer data.json');
      const json = await res.json();

      // json = { measurements: [ { ts, temperature, humidity, pressure }, ... ] }
      const labels = json.measurements.map(m => new Date(m.ts).toLocaleString());
      const temps  = json.measurements.map(m => m.temperature);
      const hums   = json.measurements.map(m => m.humidity);
      const press  = json.measurements.map(m => m.pressure);

      [tempChart, humChart, presChart].forEach(ch => { ch.data.labels = labels; });
      tempChart.data.datasets[0].data = temps;
      humChart.data.datasets[0].data  = hums;
      presChart.data.datasets[0].data = press;

      tempChart.update();
      humChart.update();
      presChart.update();
    } catch (e) {
      console.error(e);
    }
  }

  // Cargar al inicio y refrescar cada 30 s
  loadData();
  setInterval(loadData, 30_000);
</script>
</body>
</html>
